pipeline {
    agent any
    stages {
        stage('Audit tools') {                        
            steps {
                sh '''
                  git version
                  buildctl --version
                  kubectl version
                  helm version
                '''
            }
        }
        stage('Build') {
            steps {
              echo "Building image tag: docker.io/twkji/bulletin-board"
              dir ('ch11/bulletin-board') {
                sh '''
                  buildctl --addr tcp://buildkitd.default.svc.cluster.local:1234 build \
                  --frontend dockerfile.v0 \
                  --local context=/var/jenkins_home/workspace/test/test1/build/libs \
                  --local dockerfile=/var/jenkins_home/workspace/test/test1/build/libs \
                  --output type=image,name=docker.io/twkji/file-server,push=true
                '''
              }
            }
        }
        stage('Run') {
            steps {
              echo "Deploying to test"
              dir ('ch11/bulletin-board') {
                sh 'chmod +x ci/run.sh && ./ci/run.sh'
              }
            }
        }
    }
}
